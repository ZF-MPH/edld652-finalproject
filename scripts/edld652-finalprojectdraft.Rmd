---
title: "EDLD 652 Final Project Draft"
author: "Ksenia Gordeeva, Rebeccca Gordon, Amy Warnock"
date: "2/21/2022"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)


library(edld652)
library(tidyverse)
library(here)
library(janitor)
library(skimr)
library(rio)
library(fuzzyjoin)
library(viridis)
library(patchwork)
library(albersusa)
library(ggridges)
```

```{r load-datasets}
mathlea_10 <- get_data("EDFacts_math_achievement_lea_2010_2019")

rlalea_10 <- get_data("EDFacts_rla_achievement_lea_2010_2019")

fiscal2010 <- get_data("NCES_CCD_fiscal_district_2010")

mathsch_10 <- get_data("EDFacts_math_achievement_sch_2010_2019")

rlasch_10 <- get_data("EDFacts_rla_achievement_sch_2010_2019")
```

### Data Visualization 1 
#### Rebecca
**Research Question:** 

How do high school students’ subgroup makeup (i.e., Race/ethnicity, Male vs. Female, economically disadvantaged, Limited English, Migrant status, Disability status, and Homelessness) differ among states/regions? 

**Datasets:** 

- EDFacts_math_achievement_sch_2010_2019
- EDFacts_rla_achievement_sch_2010_2019

```{r rebecca-datawrangling}

df <- full_join(mathsch_10, rlasch_10) 

df2 <- df %>% 
	mutate(ECDmath = gsub("[^0-9.-]", "", ECD_MTHHSPCTPROF),
				 ECDrla = gsub("[^0-9.-]", "", ECD_RLAHSPCTPROF),
				 LEPrla = gsub("[^0-9.-]", "", LEP_RLAHSPCTPROF),
				 LEPmath = gsub("[^0-9.-]", "", LEP_MTHHSPCTPROF),
				 HOMmath = gsub("[^0-9.-]", "", HOM_MTHHSPCTPROF),
				 HOMrla = gsub("[^0-9.-]", "", HOM_RLAHSPCTPROF),
				 Mmath = gsub("[^0-9.-]", "", M_MTHHSPCTPROF),
				 Mrla = gsub("[^0-9.-]", "", M_RLAHSPCTPROF),
				 Fmath = gsub("[^0-9.-]", "", F_MTHHSPCTPROF),
				 Frla = gsub("[^0-9.-]", "", F_RLAHSPCTPROF),
				 MBLmath = gsub("[^0-9.-]", "", MBL_MTHHSPCTPROF),
				 MBLrla = gsub("[^0-9.-]", "", MBL_RLAHSPCTPROF),
				 MHImath = gsub("[^0-9.-]", "", MHI_MTHHSPCTPROF),
				 MHIrla = gsub("[^0-9.-]", "", MHI_RLAHSPCTPROF),
				 MWHmath = gsub("[^0-9.-]", "", MWH_MTHHSPCTPROF),
				 MWHrla = gsub("[^0-9.-]", "", MWH_RLAHSPCTPROF),
				 CWDmath = gsub("[^0-9.-]", "", CWD_MTHHSPCTPROF),
				 CWDrla = gsub("[^0-9.-]", "", CWD_RLAHSPCTPROF))

df2$ECDmath = readr::parse_number(df2$ECDmath) 
df2$ECDrla = readr::parse_number(df2$ECDrla) 
df2$LEPrla = readr::parse_number(df2$LEPrla) 
df2$LEPmath = readr::parse_number(df2$LEPmath) 
df2$HOMrla = readr::parse_number(df2$HOMrla) 
df2$HOMmath = readr::parse_number(df2$HOMmath) 
df2$Mrla = readr::parse_number(df2$Mrla) 
df2$Mmath = readr::parse_number(df2$Mmath) 
df2$Frla = readr::parse_number(df2$Frla) 
df2$Fmath = readr::parse_number(df2$Fmath) 
df2$MBLrla = readr::parse_number(df2$MBLrla) 
df2$MBLmath = readr::parse_number(df2$MBLmath) 
df2$MHIrla = readr::parse_number(df2$MHIrla) 
df2$MHImath = readr::parse_number(df2$MHImath) 
df2$MWHmath = readr::parse_number(df2$MWHmath) 
df2$MWHrla = readr::parse_number(df2$MWHrla) 
df2$CWDmath = readr::parse_number(df2$CWDmath) 
df2$CWDrla = readr::parse_number(df2$CWDrla) 

dat <- df2 %>% 
	group_by(STNAM) %>% 
	summarise(
		mean_EconoicallyDisadvantaged_math = mean(ECDmath, na.rm = TRUE),
		mean_EconoicallyDisadvantaged_rla = mean(ECDrla, na.rm = TRUE),
		mean_EnglishLearner_math = mean(LEPmath, na.rm = TRUE),
		mean_EnglishLearner_rla = mean(LEPrla, na.rm = TRUE),
		mean_Homeless_math = mean(HOMmath, na.rm = TRUE),
		mean_Homeless_rla = mean(HOMrla, na.rm = TRUE),
		mean_Male_math = mean(Mmath, na.rm = TRUE),
		mean_Male_rla = mean(Mrla, na.rm = TRUE),
		mean_Female_math = mean(Fmath, na.rm = TRUE),
		mean_Female_rla = mean(Frla, na.rm = TRUE),
		mean_Black_math = mean(MBLmath, na.rm = TRUE),
		mean_Black_rla = mean(MBLrla, na.rm = TRUE),
		mean_Hispanic_math = mean(MHImath, na.rm = TRUE),
		mean_Hispanic_rla = mean(MHIrla, na.rm = TRUE),
		mean_White_math = mean(MWHmath, na.rm = TRUE),
		mean_White_rla = mean(MWHrla, na.rm = TRUE),
		mean_Disabled_math = mean(CWDmath, na.rm = TRUE),
		mean_Disabled_rla = mean(CWDrla, na.rm = TRUE)
	) 

dat <- dat %>% filter(!STNAM == "BUREAU OF INDIAN AFFAIRS" & !STNAM == "stnam" & !STNAM == "PUERTO RICO") 

regions <- import(here("data","us_census_bureau_regions_and_divisions.csv")) %>%
	rename(state = `State Code`, `STNAM` = State)

df_regions <- regex_inner_join(dat, regions,ignore_case =TRUE) 

df_pivot <- df_regions %>% 
	pivot_longer(
		cols = starts_with("mean_"),
		names_to = c("Subgroup", "test"),
		values_to = "mean_pct",
		names_sep = "_",
		values_drop_na = TRUE,
		names_repair = "check_unique",
		names_prefix = "mean_"
	) 

df_pivot$STNAM.y <- as.factor(df_pivot$STNAM.y)
df_pivot$Subgroup <- as.factor(df_pivot$Subgroup)

```
```{r rebecca-plots}
#Plot showing mean test score by subgroup and test

df_pivot %>%   
	ggplot(aes(x = mean_pct, 
						 y = fct_reorder(STNAM.y, Subgroup),
						 fill = mean_pct,
						 color = test)) +
	geom_point(size = .8,
						 alpha = .7) +
	facet_wrap(~Subgroup) +
	guides(fill = "none") +
	scale_color_discrete(l = 45,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'State') +
	theme_minimal()


#Plot showing mean test score by subgroup and test by state

df_pivot %>%   
	ggplot(aes(x = mean_pct, 
						 y = fct_reorder(Subgroup, mean_pct))) +
	geom_jitter(aes(color = test),
							size = .9,
							alpha = .8) +
	facet_wrap(~STNAM.y) +
	scale_color_discrete(l = 70,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 

#Plot showing mean test score by subgroup and test by region

ggplot(df_pivot, aes(x = mean_pct, 
										 y = fct_reorder(Subgroup, mean_pct), 
										 fill = Region,
										 alpha = .7)) +
	guides(alpha = "none") +
	geom_density_ridges(rel_min_height = 0.005) +
	theme_minimal() +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 


#Trying to figure out how to show test scores separated by Gender but the plot won't create separate values for each

df_pivot %>% 
	filter(Subgroup %in% c("Male", "Female")) %>% 
	group_by(Subgroup) %>% 
	ggplot(aes(x = mean_pct,
						 y = fct_reorder(STNAM.y, mean_pct),
						 fill = paste(STNAM.y, Subgroup))) + 
	geom_density_ridges_gradient(scale = 2, size = 0.3, rel_min_height = 0.001) +
	scale_fill_viridis_c(name = "%", option = "C") +
	coord_cartesian(clip = "off") +
	theme_ridges(grid = FALSE) +
	labs(title = 'Mean percentage of economically disadvantaged students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'State') 

```

```{r rebecca-maps}
#Maps
us <- usa_sf()

us <- rename(us, state = iso_3166_2)

df_geo <- inner_join(df_pivot, us, by = "state")

dat2 <- full_join(df_pivot, df_geo)

#Math only
dat2 %>% 
	filter(test == "math") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Math",
			 caption = "Source: U.S. Department of Education") +
	theme_void()


#Reading only
dat2 %>% 
	filter(test == "rla") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

#combined map
ggplot(data = dat2, aes(geometry = geometry, 
												fill = mean_pct,
												color = test), 
			 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Across Math and Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

```
### Data Visualization 2 
#### Ksenia
**Research Question:** 

What drives current expenditure on education? How is funding allocated by state and how do the funding allocations correlate with eh student performance (graduation rates and/or test scores)? Does cross-state variation in expenditure explain the cross-state variation in education outcomes? More specifically, I might look at the following:

- What percentage of expenditure accounts for instruction/ textbooks/ technology-related equipment & services/ instructional equipment?
- What are the gross amounts spent on those categories?
- How do those percentages/ gross amounts correlate with the diversity of the student population/portion of white students in school?
- Does increased spending on any of the categories correlate with increased students’ performance?  
- Can higher teachers’ salaries result in better test scores?
- What amount of funding is spent on special education programs and how that correlates with performance of students with disabilities? 

**Datasets:**   

- EDFacts_rla_achievement_lea_2010_2019  
- EDFacts_math_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010

```{r ksenia-dataxploration}
colnames(fiscal2010)
skim(fiscal2010)

# Total spendings by state
total <-fiscal2010 %>% 
  group_by(STNAME) %>%
  summarise(TOTALEXP = sum(TOTALEXP))

total  %>%
  ggplot(aes(TOTALEXP, STNAME)) +
  geom_col()

#in descending order
total  %>%
  ggplot(aes(TOTALEXP, fct_reorder(STNAME, TOTALEXP))) +
  geom_col() 

#spending on instruction by state 
instruction <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(E13 = sum(E13))

instruction  %>%
  ggplot(aes(E13, STNAME)) +
  geom_col()

instruction  %>%
  ggplot(aes(E13, fct_reorder(STNAME, E13))) +
  geom_col()
#New York spends more on instruction, while CA spends the most total

#spending on textbooks by state 
textbooks <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(V93 = sum(V93))

textbooks  %>%
  ggplot(aes(V93, fct_reorder(STNAME, V93))) +
  geom_col()

#spending on Special Ed teachers
SpEd <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(Z36 = sum(Z36))

SpEd  %>%
  ggplot(aes(Z36, fct_reorder(STNAME, Z36))) +
  geom_col()

#next step - figure out how to show those spendings per state as a proportion of the total spending if that state
```

### Data Visualization 3 
#### Amy
**Research Question:** 

What is the relationship between districts’ local revenue and students’ literacy outcomes on statewide assessments in 2010? I plan on exploring more specific questions that may impact the direction of my final focus and data visualization, including (a) total local revenue vs. local revenue from property taxes, (b) outcomes for specific grades vs. overall, (c) outcomes for specific student race/ethnicity subgroups vs. overall, (e) examining the relationship between funding and outcomes by state, and (e) average local funding (in dollar per student) per state and/or district.  

**Datasets:**  

- EDFacts_rla_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010 

```{r amy-viz3-wrangling}

# Some initial exploration
#View(rlalea_10)
#View(fiscal2010)

colnames(rlalea_10)

rlalea_10  %>% 
  ggplot(aes(YEAR, ALL_RLA03PCTPROF)) +
             geom_point()

unique(rlalea_10$YEAR)

skim(rlalea_10)

# Going to need to clean these 
rlalea_10 %>%
  group_by(ALL_RLA03PCTPROF) %>% 
  summarize(n = n())

# Prelim exploration for fiscal file and local revenue
skim(fiscal2010)

# Total local revenue (need to adjust x-axis)
fiscal2010 %>% 
  ggplot(aes(TLOCREV)) +
  geom_histogram()

fiscal2010 %>%
  group_by(LEAID) %>% 
  summarize(TLOCREV) 

# Exploring local revenue solely from property taxes
fiscal2010 %>% 
  ggplot(aes(T06)) +
  geom_histogram()

fiscal2010 %>%
  group_by(LEAID) %>% 
  summarize(T06) 

# Local funding in property tax per student
fiscal2010 <- fiscal2010 %>% 
  mutate(taxperstu = T06/V33)

fiscal2010$taxperstu

fiscal2010 %>% 
  ggplot(aes(taxperstu)) +
  geom_histogram()

fiscal2010 %>%
  group_by(LEAID) %>% 
  summarize(taxperstu)

# I don't think this works b/c I need to clean values for the property tax variable before calculating tax per student
fiscal2010 %>%
  summarize(min_taxperstu = min(taxperstu),
            max_taxperstu = max(taxperstu)) 

```
