---
title: "EDLD 652 Final Project Draft"
author: "Ksenia Gordeeva, Rebeccca Gordon, Amy Warnock"
date: "2/21/2022"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)


library(edld652)
library(tidyverse)
library(here)
library(janitor)
library(skimr)
library(rio)
#install.packages("fuzzyjoin")
library(fuzzyjoin)
library(viridis)
library(patchwork)
library(albersusa)
library(ggridges)

```

```{r load-datasets}
mathlea_10 <- get_data("EDFacts_math_achievement_lea_2010_2019")

rlalea_10 <- get_data("EDFacts_rla_achievement_lea_2010_2019")

fiscal2010 <- get_data("NCES_CCD_fiscal_district_2010")

mathsch_10 <- get_data("EDFacts_math_achievement_sch_2010_2019")

rlasch_10 <- get_data("EDFacts_rla_achievement_sch_2010_2019")
```

### Data Visualization 1 
#### Rebecca
**Research Question:** 

How do high school students’ subgroup makeup (i.e., Race/ethnicity, Male vs. Female, economically disadvantaged, Limited English, Migrant status, Disability status, and Homelessness) differ among states/regions? 

**Datasets:** 

- EDFacts_math_achievement_sch_2010_2019
- EDFacts_rla_achievement_sch_2010_2019

```{r rebecca-datawrangling}

df <- full_join(mathsch_10, rlasch_10) 

df2 <- df %>% 
	mutate(ECDmath = gsub("[^0-9.-]", "", ECD_MTHHSPCTPROF),
				 ECDrla = gsub("[^0-9.-]", "", ECD_RLAHSPCTPROF),
				 LEPrla = gsub("[^0-9.-]", "", LEP_RLAHSPCTPROF),
				 LEPmath = gsub("[^0-9.-]", "", LEP_MTHHSPCTPROF),
				 HOMmath = gsub("[^0-9.-]", "", HOM_MTHHSPCTPROF),
				 HOMrla = gsub("[^0-9.-]", "", HOM_RLAHSPCTPROF),
				 Mmath = gsub("[^0-9.-]", "", M_MTHHSPCTPROF),
				 Mrla = gsub("[^0-9.-]", "", M_RLAHSPCTPROF),
				 Fmath = gsub("[^0-9.-]", "", F_MTHHSPCTPROF),
				 Frla = gsub("[^0-9.-]", "", F_RLAHSPCTPROF),
				 MBLmath = gsub("[^0-9.-]", "", MBL_MTHHSPCTPROF),
				 MBLrla = gsub("[^0-9.-]", "", MBL_RLAHSPCTPROF),
				 MHImath = gsub("[^0-9.-]", "", MHI_MTHHSPCTPROF),
				 MHIrla = gsub("[^0-9.-]", "", MHI_RLAHSPCTPROF),
				 MWHmath = gsub("[^0-9.-]", "", MWH_MTHHSPCTPROF),
				 MWHrla = gsub("[^0-9.-]", "", MWH_RLAHSPCTPROF),
				 CWDmath = gsub("[^0-9.-]", "", CWD_MTHHSPCTPROF),
				 CWDrla = gsub("[^0-9.-]", "", CWD_RLAHSPCTPROF))

df2$ECDmath = readr::parse_number(df2$ECDmath) 
df2$ECDrla = readr::parse_number(df2$ECDrla) 
df2$LEPrla = readr::parse_number(df2$LEPrla) 
df2$LEPmath = readr::parse_number(df2$LEPmath) 
df2$HOMrla = readr::parse_number(df2$HOMrla) 
df2$HOMmath = readr::parse_number(df2$HOMmath) 
df2$Mrla = readr::parse_number(df2$Mrla) 
df2$Mmath = readr::parse_number(df2$Mmath) 
df2$Frla = readr::parse_number(df2$Frla) 
df2$Fmath = readr::parse_number(df2$Fmath) 
df2$MBLrla = readr::parse_number(df2$MBLrla) 
df2$MBLmath = readr::parse_number(df2$MBLmath) 
df2$MHIrla = readr::parse_number(df2$MHIrla) 
df2$MHImath = readr::parse_number(df2$MHImath) 
df2$MWHmath = readr::parse_number(df2$MWHmath) 
df2$MWHrla = readr::parse_number(df2$MWHrla) 
df2$CWDmath = readr::parse_number(df2$CWDmath) 
df2$CWDrla = readr::parse_number(df2$CWDrla) 

dat <- df2 %>% 
	group_by(STNAM) %>% 
	summarise(
		mean_EconomicallyDisadvantaged_math = mean(ECDmath, na.rm = TRUE),
		mean_EconomicallyDisadvantaged_rla = mean(ECDrla, na.rm = TRUE),
		mean_EnglishLearner_math = mean(LEPmath, na.rm = TRUE),
		mean_EnglishLearner_rla = mean(LEPrla, na.rm = TRUE),
		mean_Homeless_math = mean(HOMmath, na.rm = TRUE),
		mean_Homeless_rla = mean(HOMrla, na.rm = TRUE),
		mean_Male_math = mean(Mmath, na.rm = TRUE),
		mean_Male_rla = mean(Mrla, na.rm = TRUE),
		mean_Female_math = mean(Fmath, na.rm = TRUE),
		mean_Female_rla = mean(Frla, na.rm = TRUE),
		mean_Black_math = mean(MBLmath, na.rm = TRUE),
		mean_Black_rla = mean(MBLrla, na.rm = TRUE),
		mean_Hispanic_math = mean(MHImath, na.rm = TRUE),
		mean_Hispanic_rla = mean(MHIrla, na.rm = TRUE),
		mean_White_math = mean(MWHmath, na.rm = TRUE),
		mean_White_rla = mean(MWHrla, na.rm = TRUE),
		mean_Disabled_math = mean(CWDmath, na.rm = TRUE),
		mean_Disabled_rla = mean(CWDrla, na.rm = TRUE)
	) 

dat <- dat %>% filter(!STNAM == "BUREAU OF INDIAN AFFAIRS" & !STNAM == "stnam" & !STNAM == "PUERTO RICO") 

regions <- import(here("data","us_census_bureau_regions_and_divisions.csv")) %>%
	rename(state = `State Code`, `STNAM` = State)

df_regions <- regex_inner_join(dat, regions,ignore_case = TRUE) 

df_pivot <- df_regions %>% 
	pivot_longer(
		cols = starts_with("mean_"),
		names_to = c("Subgroup", "test"),
		values_to = "mean_pct",
		names_sep = "_",
		values_drop_na = TRUE,
		names_repair = "check_unique",
		names_prefix = "mean_"
	) 

df_pivot$STNAM.y <- as.factor(df_pivot$STNAM.y)
df_pivot$Subgroup <- as.factor(df_pivot$Subgroup)

```

```{r rebecca-plots}
#Plot showing mean test score by subgroup and test
#AW: I'm getting this error message: Error in median.default(X[[i]], ...) : need numeric data

df_pivot %>%
	ggplot(aes(x = mean_pct,
						 y = fct_reorder(STNAM.y, Subgroup),
						 fill = mean_pct,
						 color = test)) +
	geom_point(size = .8,
						 alpha = .7) +
	facet_wrap(~Subgroup) +
	guides(fill = "none") +
	scale_color_discrete(l = 45,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'State') +
	theme_minimal()


#Plot showing mean test score by subgroup and test by state

df_pivot %>%   
	ggplot(aes(x = mean_pct, 
						 y = fct_reorder(Subgroup, mean_pct))) +
	geom_jitter(aes(color = test),
							size = .9,
							alpha = .8) +
	facet_wrap(~STNAM.y) +
	scale_color_discrete(l = 70,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 

#Plot showing mean test score by subgroup and test by region

ggplot(df_pivot, aes(x = mean_pct, 
										 y = fct_reorder(Subgroup, mean_pct), 
										 fill = Region,
										 alpha = .7)) +
	guides(alpha = "none") +
	geom_density_ridges(rel_min_height = 0.005) +
	theme_minimal() +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 


#Trying to figure out how to show test scores separated by Gender but the plot won't create separate values for each

#AW: I'm getting this error message: Error: Discrete value supplied to continuous scale

df_pivot %>%
	filter(Subgroup %in% c("Male", "Female")) %>%
	group_by(Subgroup) %>%
	ggplot(aes(x = mean_pct,
						 y = fct_reorder(STNAM.y, mean_pct),
						 fill = paste(STNAM.y, Subgroup))) +
	geom_density_ridges_gradient(scale = 2, size = 0.3, rel_min_height = 0.001) +
	scale_fill_viridis_c(name = "%", option = "C") +
	coord_cartesian(clip = "off") +
	theme_ridges(grid = FALSE) +
	labs(title = 'Mean percentage of economically disadvantaged students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'State')

```

```{r rebecca-maps}
#Maps
#AW: Should map titles include "economically disadvantaged?" They look like they include all student subgroups to me. 

us <- usa_sf()

us <- rename(us, state = iso_3166_2)

df_geo <- inner_join(df_pivot, us, by = "state")

dat2 <- full_join(df_pivot, df_geo)

#Math only
dat2 %>% 
	filter(test == "math") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Math",
			 caption = "Source: U.S. Department of Education") +
	theme_void()


#Reading only
dat2 %>% 
	filter(test == "rla") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

#combined map
ggplot(data = dat2, aes(geometry = geometry, 
												fill = mean_pct,
												color = test), 
			 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of economically disadvantaged students that scored at or above proficient",
			 subtitle = "Across Math and Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

```

### Data Visualization 2 

#### Ksenia

**Research Question:** 

What drives current expenditure on education? How is funding allocated by state and how do the funding allocations correlate with eh student performance (graduation rates and/or test scores)? Does cross-state variation in expenditure explain the cross-state variation in education outcomes? More specifically, I might look at the following:

- What percentage of expenditure accounts for instruction/ textbooks/ technology-related equipment & services/ instructional equipment?
- What are the gross amounts spent on those categories?
- How do those percentages/ gross amounts correlate with the diversity of the student population/portion of white students in school?
- Does increased spending on any of the categories correlate with increased students’ performance?  
- Can higher teachers’ salaries result in better test scores?
- What amount of funding is spent on special education programs and how that correlates with performance of students with disabilities? 

**Datasets:**   

- EDFacts_rla_achievement_lea_2010_2019  
- EDFacts_math_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010

```{r ksenia-dataxploration}
colnames(fiscal2010)
skim(fiscal2010)

# Total spendings by state
total <-fiscal2010 %>% 
  group_by(STNAME) %>%
  summarise(TOTALEXP = sum(TOTALEXP))

total  %>%
  ggplot(aes(TOTALEXP, STNAME)) +
  geom_col()

#in descending order
total  %>%
  ggplot(aes(TOTALEXP, fct_reorder(STNAME, TOTALEXP))) +
  geom_col() 

#spending on instruction by state 
instruction <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(E13 = sum(E13))

instruction  %>%
  ggplot(aes(E13, STNAME)) +
  geom_col()

instruction  %>%
  ggplot(aes(E13, fct_reorder(STNAME, E13))) +
  geom_col()
#New York spends more on instruction, while CA spends the most total

#spending on textbooks by state 
textbooks <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(V93 = sum(V93))

textbooks  %>%
  ggplot(aes(V93, fct_reorder(STNAME, V93))) +
  geom_col()

#spending on Special Ed teachers
SpEd <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(Z36 = sum(Z36))

SpEd  %>%
  ggplot(aes(Z36, fct_reorder(STNAME, Z36))) +
  geom_col()

#next step - figure out how to show those spendings per state as a proportion of the total spending if that state
```

### Data Visualization 3 
#### Amy
**Research Question:** 

What is the relationship between the local revenue of local education agencies and students’ literacy outcomes on statewide assessments in 2010? Additional areas of exploration included (a) average total local revenue and local revenue property taxes by state, (b) the relationship between outcomes and total local revenue vs. local revenue from property taxes, (c) the relationship between both types of funding and outcomes by state, and (d) relationship between both types of revenue and outcomes of student subgroups (e.g., race/ethnicity, disability status, language proficiency, SES). 

**Datasets:**  

- EDFacts_rla_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010 

**Variables:**

EDFacts_rla_achievement_lea_2010_2019

- YEAR
- STNAM
- FIPST
- LEAID
- ALL_RLA00PCTPROF = Percentage of all students who scored at or above their state's proficiency level on Reading/Language Arts.
- MAM_RLA03PCTPROF = Percentage of Native American students that scored at or above proficient
- MAS_RLA00PCTPROF = Percentage of Asian/Pacific Islander students that scored at or above proficient
- MBL_RLA00PCTPROF = Percentage of Black students that scored at or above proficient
- MHI_RLA00PCTPROF = Percentage of Hispanic students that scored at or above proficient
- MTR_RLA00PCTPROF = Percentage of students with Two or More Races that scored at or above proficient
- MWH_RLA03PCTPROF = Percentage of White students that scored at or above proficient
- CWD_RLA00PCTPROF = Percentage of children with disabilities that scored at or above proficient
- ECD_RLA00PCTPROF = Percentage of economically disadvantaged students that scored at or above proficient
- LEP_RLA00PCTPROF = Percentage of limited English proficient students that scored at or above proficient

NCES_CCD_fiscal_district_2010:

- NAME 
- STABBR
- CENSUSID
- V33 = LEA fall membership (i.e., number of students) 
- TOTALREV = LEA total revenue
- TFEDREV = LEA total federal revenue
- TSTREV = LEA total state revenue
- TLOCREV = LEA total local revenue 
- T06 = LEA local revenue from property taxes

**Cleaning and Wrangling**

```{r amy-viz3-cleaning-fiscal}
# Selected columns of interest. Filtered so that rows with suppressed values (e.g., -9, -2) for key variables of interest weren't included. 
viz3_fiscal2010 <- fiscal2010 %>% 
  select(LEAID, NAME, STABBR, CENSUSID, V33,
         TOTALREV, TFEDREV, TSTREV, TLOCREV, T06) %>% 
  filter(V33 > 0, TLOCREV > 0, T06 > 0) %>%
  rename_with(tolower) %>% 
  rename(totalstu = v33, tlocrevtaxes = t06) %>% 
  mutate(locrev_stu = tlocrev / totalstu,
         locrevtaxes_stu = tlocrevtaxes / totalstu)
```

```{r amy-viz3-rla-allgrades-cleaning-wrangling}
# Narrowed the RLA 2010 file down to variables of interest. Selected percent proficient variables across all grades (00) for race ethnicity, disability, English Language Learner status, and economically disadvantaged subgroups. Transformed variable names to be lowercase, transformed state names to be title case, and replaced the suppressed values (e.g., PS, n/a, etc.) with NA.
viz3_rlalea00 <- rlalea_10 %>% 
  select(YEAR, 
         STNAM, 
         FIPST,
         LEAID, 
         ALL_RLA00PCTPROF, 
         MAM_RLA00PCTPROF,
         MAS_RLA00PCTPROF,
         MBL_RLA00PCTPROF,
         MHI_RLA00PCTPROF,
         MTR_RLA00PCTPROF, 
         MWH_RLA00PCTPROF,
         CWD_RLA00PCTPROF,
         ECD_RLA00PCTPROF,
         LEP_RLA00PCTPROF) %>% 
  rename_with(tolower)  %>% 
  mutate(stnam = str_to_title(stnam), 
         (across(all_rla00pctprof:lep_rla00pctprof, 
                 ~replace(., . %in% c("PS", 
                                      "n/a",	
                                      "LT50",	
                                      "LE5",	
                                      "LE20",	
                                      "LE10",	
                                      "GE99",	
                                      "GE95",	
                                      "GE90",	
                                      "GE80",	
                                      "GE50"), NA))))

# Next step was cleaning the percentage columns to change percentage ranges to average percentages. I used the method Daniel used on the course data webpage and applied it to all subgroups.

# All = across all students
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(all_rla00pctprof, c("all_lower", "all_upper"), sep = "-") %>% 
  mutate(
    all_upper = ifelse(is.na(all_upper), all_lower, all_upper),
    all_lower = as.numeric(all_lower),
    all_upper = as.numeric(all_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_all = mean(c(all_lower, all_upper))) %>% 
  ungroup()

# mam = American Indian/Alaska Native
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mam_rla00pctprof, c("mam_lower", "mam_upper"), sep = "-") %>% 
  mutate(
    mam_upper = ifelse(is.na(mam_upper), mam_lower, mam_upper),
    mam_lower = as.numeric(mam_lower),
    mam_upper = as.numeric(mam_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mam = mean(c(mam_lower, mam_upper))) %>% 
  ungroup()

# mas = Asian/Pacific Islander
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mas_rla00pctprof, c("mas_lower", "mas_upper"), sep = "-") %>% 
  mutate(
    mas_upper = ifelse(is.na(mas_upper), mas_lower, mas_upper),
    mas_lower = as.numeric(mas_lower),
    mas_upper = as.numeric(mas_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mas = mean(c(mas_lower, mas_upper))) %>% 
  ungroup()

# mbl = Black
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mbl_rla00pctprof, c("mbl_lower", "mbl_upper"), sep = "-") %>% 
  mutate(
    mbl_upper = ifelse(is.na(mbl_upper), mbl_lower, mbl_upper),
    mbl_lower = as.numeric(mbl_lower),
    mbl_upper = as.numeric(mbl_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mbl = mean(c(mbl_lower, mbl_upper))) %>% 
  ungroup()

# mhi = Hispanic/Latino
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mhi_rla00pctprof, c("mhi_lower", "mhi_upper"), sep = "-") %>% 
  mutate(
    mhi_upper = ifelse(is.na(mhi_upper), mhi_lower, mhi_upper),
    mhi_lower = as.numeric(mhi_lower),
    mhi_upper = as.numeric(mhi_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mhi = mean(c(mhi_lower, mhi_upper))) %>% 
  ungroup()

# mtr = Multiracial
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mtr_rla00pctprof, c("mtr_lower", "mtr_upper"), sep = "-") %>% 
  mutate(
    mtr_upper = ifelse(is.na(mtr_upper), mtr_lower, mtr_upper),
    mtr_lower = as.numeric(mtr_lower),
    mtr_upper = as.numeric(mtr_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mtr = mean(c(mtr_lower, mtr_upper))) %>% 
  ungroup()

# mwh = White
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mwh_rla00pctprof, c("mwh_lower", "mwh_upper"), sep = "-") %>% 
  mutate(
    mwh_upper = ifelse(is.na(mwh_upper), mwh_lower, mwh_upper),
    mwh_lower = as.numeric(mwh_lower),
    mwh_upper = as.numeric(mwh_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mwh = mean(c(mwh_lower, mwh_upper))) %>% 
  ungroup()

# cwd = children with disabilities
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(cwd_rla00pctprof, c("cwd_lower", "cwd_upper"), sep = "-") %>% 
  mutate(
    cwd_upper = ifelse(is.na(cwd_upper), cwd_lower, cwd_upper),
    cwd_lower = as.numeric(cwd_lower),
    cwd_upper = as.numeric(cwd_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_cwd = mean(c(cwd_lower, cwd_upper))) %>% 
  ungroup()

# ecd = economically disadvantaged
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(ecd_rla00pctprof, c("ecd_lower", "ecd_upper"), sep = "-") %>% 
  mutate(
    ecd_upper = ifelse(is.na(ecd_upper), ecd_lower, ecd_upper),
    ecd_lower = as.numeric(ecd_lower),
    ecd_upper = as.numeric(ecd_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_ecd = mean(c(ecd_lower, ecd_upper))) %>% 
  ungroup()

# lep = limited English proficiency (English Language Learner)
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(lep_rla00pctprof, c("lep_lower", "lep_upper"), sep = "-") %>% 
  mutate(
    lep_upper = ifelse(is.na(lep_upper), lep_lower, lep_upper),
    lep_lower = as.numeric(lep_lower),
    lep_upper = as.numeric(lep_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_lep = mean(c(lep_lower, lep_upper))) %>% 
  ungroup()

# Get ride of the "_lower" and "_upper" percentage columns since they won't be needed
viz3_rlalea00 <- viz3_rlalea00 %>% 
  select(year, 
         stnam, 
         fipst,
         leaid,
         contains("meanpctprof"))
```

```{r amy-viz3-rla-allgrades-pivotlonger}
# Pivoted the dataset longer to have a column for subgroup and a column for mean percentage proficient. 

viz3_rlalea00_long <- viz3_rlalea00 %>%
  pivot_longer(
 		cols = contains("meanpctprof"),
 		names_to = "subgroup",
 		values_to = "meanpctprof",
 		names_prefix = "meanpctprof_") 
```

```{r amy-viz3-rla-allgrades-join}
# Joined the long file with the cleaned/narrowed fiscal data file. Used an inner join because I'm only interested in LEAs that have both student proficiency and fiscal data. 
viz3_rla00long_fiscal_2010 <- inner_join(viz3_rlalea00_long, 
                                         viz3_fiscal2010, 
                                         by = "leaid")
```

**Potential Visualizations**

These are the data visualizations I am thinking I will choose from for our final product. I'm not going to include all of these. My primary next step is to narrow them down. Please note that they are still a bit rough and need refinement (some more than others). Refinement plans include... finalizing color, trying out annotations and/or highlighting, and exploring alternate options for faceting by state. If I include the plots with fitted lines, I plan to update the colors and replace the legend with annotations.

First off, bar graphs. The first two summarize LEA local revenue and LEA local revenue from property taxes averaged by state. The third graph summarizes the average percentage of students scoring at/above proficient by state. 

```{r amy-viz3-bargraphs, fig.height=7}
# Bar graph: Average LEA total local revenue ($ per student) by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_locrev_stu = mean(locrev_stu)) %>% 
  ggplot(aes(x = mean_locrev_stu, y = fct_reorder(stnam, mean_locrev_stu))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                     breaks = c(0, 2500, 5000, 7500, 10000, 12500),
                     labels = scales::dollar) +
  labs(title = "Average Local Revenue of LEAs",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  

# Bar graph: Average LEA local revenue from property taxes ($ per student) by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_locrevtaxes_stu = mean(locrevtaxes_stu)) %>% 
  ggplot(aes(x = mean_locrevtaxes_stu, 
             y = fct_reorder(stnam, mean_locrevtaxes_stu))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                    breaks = c(0, 2500, 5000, 7500, 10000),
                     labels = scales::dollar) +
  labs(title = "Average Local Revenue of LEAs from Property Taxes",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())

# Bar graph of average RLA proficiency for each state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_pctprof = mean(meanpctprof, na.rm = T)) %>% 
  ggplot(aes(x = mean_pctprof, y = fct_reorder(stnam, mean_pctprof))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                    breaks = c(0, 20, 40, 60, 80),
                    labels = c("0%", "20%", "40%", "60%", "80%")) +
  labs(title = "Average Proficiency in Reading/Language Arts",
       subtitle = "Students in Grades 3 through HS",
       y = "State",
       x = "Average Percentage",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  
```

Density ridges of local revenue from property taxes for LEAs by state. One thing I plan to do, if I include this plot, that I didn't get to is sorting the states by mean revenue.

```{r amy-viz3-densityridges, fig.height=7}
# Density ridges of local revenue from property taxes across LEAs by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  ggplot(aes(x = locrevtaxes_stu, y = stnam)) +
 	geom_density_ridges(fill = "cornflower blue", color = "white", alpha = .8) +
 	theme_minimal() +
  labs(title = "Local Revenue from Property Taxes in LEAS of Each State",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot") + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 25000))
```

Scatterplots showing the relationship between types of revenue and average percentage of students scoring at/above proficient on statewide assessments of reading/language arts. Note that I used a log transformation of the x-axis to spread the points out. Without the transformation, the bulk of the points were clustered near the bottom of the range. I think that I could use highlighting and annotations for the lowest and highest points.

```{r amy-viz3-scatterplots1, fig.width=7, fig.height=7}
# Scatterplots: All students, LEA total local revenue ($ per stu) and LEA local revenue from property taxes by approx. pct proficient
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Relationship between Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Scatterplots faceted by state. 

```{r amy-viz3-scatterplots2, fig.height=10, fig.width=12}
# Scatterplot: All students - relationship between local revenue ($ per student) and mean % proficient, faceted by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Total Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

# Scatterplot: All students - relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Scatterplots showing the relationship between revenue and outcomes, faceted by subgroup. These are still pretty rough (e.g., labels need work).

```{r amy-viz3-scatterplots3, fig.height=10, fig.width=10}
# Scatterplot: Relationship between local revenue ($ per student) and mean % proficient, faceted by subgroup
viz3_rla00long_fiscal_2010 %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~subgroup) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Total Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

# Scatterplot: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by subgroup
viz3_rla00long_fiscal_2010 %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  facet_wrap(~subgroup) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Playing around with fitting lines. These are still rough. I need to work on the legend and want to try replacing it with annotations. Also could consider changing the color to highlight a specific group or pick a different color palette. 

```{r amy-viz3-fittedlines}
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Fitted lines faceted by state (also very rough).

```{r amy-viz3-fittedlines2, fig.height=10, fig.width=12}
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot() +
  geom_smooth(method = lm, se = F, aes(x = locrevtaxes_stu, y = meanpctprof, color = subgroup)) +
  facet_wrap(~stnam) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Created maps displaying (a) average LEA local revenue in each state and (b) average LEA local revenue from property taxes in each state. I still need to fill in the missing states and want to try out different color palettes.  

```{r amy-viz3-map}
viz3_map_dfprep <- viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  group_by(stnam) %>% 
  summarize(mean_locrev_stu = mean(locrev_stu),
            mean_locrevtaxes_stu = mean(locrevtaxes_stu))

viz3_us <- usa_sf() 

viz3_map_df <- left_join(viz3_map_dfprep, 
                      viz3_us, 
                      by = c("stnam" = "name"))

viz3_map_df %>% 
  ggplot(aes(geometry = geometry, fill = mean_locrev_stu)) +
  geom_sf(color = "white", size = 0) +
 	scale_fill_viridis(option = "magma", 
 	                   name = "Dollar per student",
 										 breaks = c(0, 2500, 5000, 7500, 10000, 12500),
 										 labels = c("$0", 
 										            "$2,500", 
 										            "$5,000", 
 										            "$7,500", 
 										            "$10,000",
 										            "$12,500")) +
  theme_void() +
  labs(title = "Average LEA Total Local Revenue",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme(plot.title.position = "plot") 


viz3_map_df %>% 
  ggplot(aes(geometry = geometry, fill = mean_locrevtaxes_stu)) +
  geom_sf(color = "white", size = 0) +
 	scale_fill_viridis(option = "magma", 
 	                   name = "Dollar per student",
 										 breaks = c(0, 2500, 5000, 7500, 10000),
 										 labels = c("$0", 
 										            "$2,500", 
 										            "$5,000", 
 										            "$7,500", 
 										            "$10,000")) +
  theme_void() +
  labs(title = "Average LEA Local Revenue from Property Taxes",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme(plot.title.position = "plot") 
```

**Other Data Visualizations**

These are some of the preliminary visualizations I did that I don't think I'm moving forward with. Because of this, refinement is minimal. 

```{r amy-viz3-prelim1}
# Scatterplot: Total local LEA revenue from property taxes ($ per stu) x approx. pct proficient, color = subgroup
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof, color = subgroup)) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  labs(title = "Revenue from property tax x meanpctprof, color by subgroup") +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Fitted lines for specific states:
```{r amy-viz3-prelim2}
# fitted lines in a few specific states
viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "Montana") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  +
  labs(title = "Montana")

viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "South Dakota") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(title = "South Dakota")

viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "New Jersey") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(title = "New Jersey")
```

```{r amy-viz3-prelim3}
# Fitting a line over data points for local revenue x meanpctprof by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  geom_smooth(method = "lm") +
  facet_wrap(~stnam) +
  geom_point(alpha = .1) + 
  scale_x_log10(labels = scales::dollar) 
```

```{r amy-viz3-prelim4}
# Scatterplot: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state, color by subgroup 
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof, color = subgroup)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar)
```

Scatterplots for each student subgroup between local revenue from property tax and % proficient, faceted by state. The subgroup is indicated in the title. 

```{r amy-viz3-prelim5}
# Scatterplots: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state for each subgroup 

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mam") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "American Indian/Alaska Native")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mas") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Asian/Pacific Islander")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mhi") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Hispanic/Latino")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mbl") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Black")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mwh") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "White")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mtr") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Multiracial")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "cwd") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Students with Disabilities")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "ecd") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Economically Disadvantaged")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "lep") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Limited English Proficiency")
```
